@using PolyPilot.Services
@using PolyPilot.Models
@inject IJSRuntime JS
@inject RepoManager RepoManager

<div class="new-session">
    <input type="text" value="@SessionName" @oninput="OnNameInput" @onkeydown="HandleKeyDown" placeholder="Session name..." />
    <div class="session-options-row">
        <ModelSelector Value="@SelectedModel" ValueChanged="OnModelSelected" Models="AvailableModels" CssClass="model-select-wrapper" />
        @if (RepoManager.Repositories.Count > 0)
        {
            <button class="dir-toggle-btn @(showWorktreePicker ? "active" : "")" @onclick="ToggleWorktreePicker" title="Use worktree">⑂</button>
        }
        <button class="dir-toggle-btn" @onclick="() => { showDirectoryInput = !showDirectoryInput; showWorktreePicker = false; }" title="Set working directory">⋯</button>
        <button class="dir-toggle-btn" @onclick="() => showPromptInput = !showPromptInput" title="Initial prompt">@(showPromptInput ? "▾" : "▸")</button>
        <button @onclick="TriggerCreate" disabled="@(IsCreating || isCreatingWorktree || string.IsNullOrWhiteSpace(SessionName))" title="Create new session">
            @(IsCreating ? "..." : "+")
        </button>
    </div>
    @if (showWorktreePicker)
    {
        <div class="worktree-picker">
            @foreach (var repo in RepoManager.Repositories)
            {
                var repoId = repo.Id;
                var repoWorktrees = RepoManager.Worktrees.Where(w => w.RepoId == repo.Id).ToList();
                <div class="wt-repo-name">@repo.Name</div>
                @foreach (var wt in repoWorktrees)
                {
                    var wtId = wt.Id;
                    <div class="wt-option-row">
                        <button class="wt-option @(selectedWorktreeId == wt.Id ? "selected" : "")" @onclick="() => SelectWorktree(wt)">
                            <span class="wt-branch">⑂ @wt.Branch</span>
                            @if (wt.PrNumber.HasValue)
                            {
                                <span class="wt-pr-badge">#@wt.PrNumber</span>
                            }
                        </button>
                        <button class="wt-delete-btn" @onclick="() => RemoveWorktree(wtId)" title="Remove worktree">×</button>
                    </div>
                }
                @if (newWorktreeRepoId == repoId)
                {
                    <div class="wt-mode-toggle">
                        <button class="wt-mode @(newWorktreeMode == "branch" ? "active" : "")"
                                @onclick='() => newWorktreeMode = "branch"'>Branch</button>
                        <button class="wt-mode @(newWorktreeMode == "pr" ? "active" : "")"
                                @onclick='() => newWorktreeMode = "pr"'>PR</button>
                    </div>
                    <div class="wt-new-form">
                        @if (newWorktreeMode == "branch")
                        {
                            <input type="text" @bind="newWorktreeBranch" placeholder="branch-name"
                                   class="wt-branch-input" @onkeydown="HandleNewWorktreeKeyDown" />
                        }
                        else
                        {
                            <input type="text" @bind="newWorktreePr" placeholder="PR #"
                                   class="wt-branch-input" @onkeydown="HandleNewWorktreeKeyDown" />
                        }
                        <button class="wt-create-btn" @onclick="CreateAndSelectWorktree"
                                disabled="@(isCreatingWorktree || (newWorktreeMode == "branch" ? string.IsNullOrWhiteSpace(newWorktreeBranch) : string.IsNullOrWhiteSpace(newWorktreePr)))">
                            @(isCreatingWorktree ? "…" : "⑂")
                        </button>
                    </div>
                    @if (!string.IsNullOrEmpty(worktreeError))
                    {
                        <div class="wt-error">⚠ @worktreeError</div>
                    }
                }
                else
                {
                    <button class="wt-option wt-new" @onclick="() => StartNewWorktreeForm(repoId)">
                        + New worktree…
                    </button>
                }
            }
        </div>
    }
    @if (showDirectoryInput)
    {
        <div class="dir-input-row">
            <input type="text" @bind="sessionDirectory"
                   placeholder="Working directory (default: PolyPilot)" 
                   class="dir-input" />
            <button class="dir-browse-btn" @onclick="BrowseDirectory" title="Browse folders">…</button>
        </div>
    }
    @if (showPromptInput)
    {
        <textarea @bind="initialPrompt" placeholder="Initial prompt (sent when session starts)..."
                  class="initial-prompt-input" rows="2"></textarea>
    }
    @if (!string.IsNullOrEmpty(selectedWorktreePath))
    {
        <div class="wt-selected">
            ⑂ @selectedWorktreeBranch
            <button class="wt-clear" @onclick="ClearWorktree" title="Clear">✕</button>
        </div>
    }
    @if (!string.IsNullOrEmpty(CreateError))
    {
        <div style="color:#ff6b6b;font-size:0.75rem;padding:2px 4px;">⚠ @CreateError</div>
    }
</div>

@code {
    [Parameter] public bool IsCreating { get; set; }
    [Parameter] public string? CreateError { get; set; }
    [Parameter] public List<string> AvailableModels { get; set; } = new();
    [Parameter] public string SelectedModel { get; set; } = "claude-opus-4.6";
    [Parameter] public EventCallback<string> SelectedModelChanged { get; set; }
    
    [Parameter] public EventCallback<(string Name, string Model, string Directory, string? WorktreeId, string? InitialPrompt)> OnCreate { get; set; }
    [Parameter] public EventCallback OnBrowseDirectory { get; set; }
    [Parameter] public string SessionName { get; set; } = "";
    [Parameter] public EventCallback<string> SessionNameChanged { get; set; }
    
    private string sessionDirectory = "";
    private bool showDirectoryInput = false;
    private bool showWorktreePicker = false;
    private bool showPromptInput = false;
    private string initialPrompt = "";
    private string? selectedWorktreePath;
    private string? selectedWorktreeId;
    private string? selectedWorktreeBranch;

    // Inline new-worktree creation state
    private string? newWorktreeRepoId;
    private string newWorktreeBranch = "";
    private string newWorktreePr = "";
    private string newWorktreeMode = "branch";
    private string? worktreeError;
    private bool isCreatingWorktree;

    private void ToggleWorktreePicker()
    {
        showWorktreePicker = !showWorktreePicker;
        if (!showWorktreePicker)
        {
            newWorktreeRepoId = null;
            worktreeError = null;
        }
        showDirectoryInput = false;
    }

    private void StartNewWorktreeForm(string repoId)
    {
        newWorktreeRepoId = repoId;
        newWorktreeBranch = "";
        newWorktreePr = "";
        newWorktreeMode = "branch";
        worktreeError = null;
    }

    private async Task OnNameInput(ChangeEventArgs e)
    {
        SessionName = e.Value?.ToString() ?? "";
        await SessionNameChanged.InvokeAsync(SessionName);
    }

    private async Task OnModelSelected(string model)
    {
        SelectedModel = model;
        await SelectedModelChanged.InvokeAsync(model);
    }

    private void SelectWorktree(WorktreeInfo wt)
    {
        sessionDirectory = wt.Path;
        selectedWorktreePath = wt.Path;
        selectedWorktreeId = wt.Id;
        selectedWorktreeBranch = wt.Branch;
        showWorktreePicker = false;
        showDirectoryInput = false;
        newWorktreeRepoId = null;
    }

    private void ClearWorktree()
    {
        selectedWorktreePath = null;
        selectedWorktreeId = null;
        selectedWorktreeBranch = null;
        sessionDirectory = "";
    }

    private async Task HandleNewWorktreeKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter") await CreateAndSelectWorktree();
        else if (e.Key == "Escape") newWorktreeRepoId = null;
    }

    private async Task CreateAndSelectWorktree()
    {
        if (isCreatingWorktree || newWorktreeRepoId == null) return;

        if (newWorktreeMode == "pr")
        {
            if (!int.TryParse(newWorktreePr.Trim().TrimStart('#'), out var prNum) || prNum <= 0)
            {
                worktreeError = "Enter a valid PR number";
                return;
            }
            isCreatingWorktree = true;
            worktreeError = null;
            try
            {
                var wt = await RepoManager.CreateWorktreeFromPrAsync(newWorktreeRepoId, prNum);
                SelectWorktree(wt);
                // Auto-fill session name if empty
                if (string.IsNullOrWhiteSpace(SessionName))
                {
                    SessionName = $"PR #{prNum}";
                    await SessionNameChanged.InvokeAsync(SessionName);
                }
            }
            catch (Exception ex)
            {
                worktreeError = ex.Message;
            }
            finally
            {
                isCreatingWorktree = false;
            }
        }
        else
        {
            if (string.IsNullOrWhiteSpace(newWorktreeBranch)) return;
            isCreatingWorktree = true;
            worktreeError = null;
            try
            {
                var wt = await RepoManager.CreateWorktreeAsync(newWorktreeRepoId, newWorktreeBranch.Trim());
                SelectWorktree(wt);
            }
            catch (Exception ex)
            {
                worktreeError = ex.Message;
            }
            finally
            {
                isCreatingWorktree = false;
            }
        }
    }

    private async Task RemoveWorktree(string worktreeId)
    {
        try
        {
            // Clear selection if removing the selected worktree
            if (selectedWorktreeId == worktreeId)
                ClearWorktree();
            await RepoManager.RemoveWorktreeAsync(worktreeId);
        }
        catch (Exception ex)
        {
            worktreeError = ex.Message;
        }
    }

    private async Task TriggerCreate()
    {
        if (!string.IsNullOrWhiteSpace(SessionName))
        {
            var prompt = string.IsNullOrWhiteSpace(initialPrompt) ? null : initialPrompt.Trim();
            await OnCreate.InvokeAsync((SessionName, SelectedModel, sessionDirectory, selectedWorktreeId, prompt));
            selectedWorktreePath = null;
            selectedWorktreeId = null;
            selectedWorktreeBranch = null;
            sessionDirectory = "";
            initialPrompt = "";
            showPromptInput = false;
        }
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !showPromptInput)
        {
            await TriggerCreate();
        }
    }
    
    private async Task BrowseDirectory()
    {
#if MACCATALYST || WINDOWS
        try
        {
            var dir = await FolderPickerService.PickFolderAsync();
            if (!string.IsNullOrEmpty(dir))
            {
                sessionDirectory = dir;
                selectedWorktreePath = null;
                selectedWorktreeId = null;
                selectedWorktreeBranch = null;
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Folder picker error: {ex.Message}");
        }
#else
        await OnBrowseDirectory.InvokeAsync();
#endif
    }
    
    public void SetDirectory(string path)
    {
        sessionDirectory = path;
        selectedWorktreePath = null;
        selectedWorktreeId = null;
        selectedWorktreeBranch = null;
        StateHasChanged();
    }
}
