@using PolyPilot.Services
@using PolyPilot.Models
@inject IJSRuntime JS

<div class="new-session">
    <input type="text" value="@SessionName" @oninput="OnNameInput" @onkeydown="HandleKeyDown" placeholder="Session name..." />
    <div class="session-options-row">
        <select @bind="SelectedModel" @bind:after="OnModelChanged" class="model-select">
            @foreach (var model in AvailableModels)
            {
                <option value="@model">@model</option>
            }
        </select>
        <button class="dir-toggle-btn" @onclick="() => showDirectoryInput = !showDirectoryInput" title="Set working directory">⋯</button>
        <button @onclick="TriggerCreate" disabled="@(IsCreating || string.IsNullOrWhiteSpace(SessionName))">
            @(IsCreating ? "..." : "+")
        </button>
    </div>
    @if (showDirectoryInput)
    {
        <div class="dir-input-row">
            <input type="text" @bind="sessionDirectory"
                   placeholder="Working directory (default: PolyPilot)" 
                   class="dir-input" />
            <button class="dir-browse-btn" @onclick="BrowseDirectory" title="Browse folders">…</button>
        </div>
    }
    @if (!string.IsNullOrEmpty(CreateError))
    {
        <div style="color:#ff6b6b;font-size:0.75rem;padding:2px 4px;">⚠ @CreateError</div>
    }
</div>

@code {
    [Parameter] public bool IsCreating { get; set; }
    [Parameter] public string? CreateError { get; set; }
    [Parameter] public List<string> AvailableModels { get; set; } = new();
    [Parameter] public string SelectedModel { get; set; } = "claude-opus-4.6";
    [Parameter] public EventCallback<string> SelectedModelChanged { get; set; }
    
    [Parameter] public EventCallback<(string Name, string Model, string Directory)> OnCreate { get; set; }
    [Parameter] public EventCallback OnBrowseDirectory { get; set; } // If we want parent to handle browse dialog (e.g. using Maui essentials) or we can do it here if we inject service?
    // SessionSidebar uses Electron-like dialog or something?
    // Let's look at SessionSidebar.BrowseDirectory. 
    // It's likely platform specific. If I can't move the logic easily, I'll callback.
    [Parameter] public string SessionName { get; set; } = "";
    [Parameter] public EventCallback<string> SessionNameChanged { get; set; }
    
    private string sessionDirectory = "";
    private bool showDirectoryInput = false;

    private async Task OnNameInput(ChangeEventArgs e)
    {
        SessionName = e.Value?.ToString() ?? "";
        await SessionNameChanged.InvokeAsync(SessionName);
    }

    private async Task OnModelChanged()
    {
        await SelectedModelChanged.InvokeAsync(SelectedModel);
    }

    private async Task TriggerCreate()
    {
        if (!string.IsNullOrWhiteSpace(SessionName))
        {
            await OnCreate.InvokeAsync((SessionName, SelectedModel, sessionDirectory));
        }
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await TriggerCreate();
        }
    }
    
    private async Task BrowseDirectory()
    {
#if MACCATALYST || WINDOWS
        try
        {
            var dir = await FolderPickerService.PickFolderAsync();
            if (!string.IsNullOrEmpty(dir))
            {
                sessionDirectory = dir;
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Folder picker error: {ex.Message}");
        }
#else
        await OnBrowseDirectory.InvokeAsync();
#endif
    }
    
    public void SetDirectory(string path)
    {
        sessionDirectory = path;
        StateHasChanged();
    }
}
