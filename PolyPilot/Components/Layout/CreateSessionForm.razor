@using PolyPilot.Services
@using PolyPilot.Models
@inject IJSRuntime JS
@inject RepoManager RepoManager
@inject CopilotService CopilotService

@if (!isExpanded)
{
    <button class="new-session-btn" @onclick="Expand">+ New Session</button>
}
else
{
    <div class="new-session-form">
        @* Mode chips ‚Äî shown only when repos exist *@
        @if (RepoManager.Repositories.Count > 0)
        {
            <div class="ns-mode-chips">
                <button class="ns-chip @(mode == FormMode.Repo ? "active" : "")" @onclick="() => SetMode(FormMode.Repo)">üì¶ Repo</button>
                <button class="ns-chip @(mode == FormMode.Directory ? "active" : "")" @onclick="() => SetMode(FormMode.Directory)">üìÅ Directory</button>
                <button class="ns-chip @(mode == FormMode.Empty ? "active" : "")" @onclick="() => SetMode(FormMode.Empty)">üí¨ Empty</button>
            </div>
        }

        @* Repo mode: repo selector + worktree strategy *@
        @if (mode == FormMode.Repo)
        {
            @if (RepoManager.Repositories.Count > 1)
            {
                <select class="ns-repo-select" value="@selectedRepoId" @onchange="OnRepoChanged">
                    @foreach (var repo in RepoManager.Repositories)
                    {
                        <option value="@repo.Id">@repo.Name</option>
                    }
                </select>
            }
            else
            {
                <div class="ns-repo-label">üì¶ @RepoManager.Repositories[0].Name</div>
            }

            <div class="ns-wt-segment">
                <button class="ns-seg @(wtMode == WtMode.Auto ? "active" : "")" @onclick="() => SetWtMode(WtMode.Auto)">‚ö° Auto</button>
                <button class="ns-seg @(wtMode == WtMode.Branch ? "active" : "")" @onclick="() => SetWtMode(WtMode.Branch)">‚ëÇ Branch</button>
                <button class="ns-seg @(wtMode == WtMode.PR ? "active" : "")" @onclick="() => SetWtMode(WtMode.PR)"># PR</button>
                <button class="ns-seg @(wtMode == WtMode.Existing ? "active" : "")" @onclick="() => SetWtMode(WtMode.Existing)">üìÇ Existing</button>
            </div>

            @if (wtMode == WtMode.Branch)
            {
                <input type="text" @bind="branchInput" @bind:event="oninput" @onkeyup="HandleInputKeyUp"
                       placeholder="branch-name" class="ns-input" />
            }
            else if (wtMode == WtMode.PR)
            {
                <input type="text" @bind="prInput" @bind:event="oninput" @onkeyup="HandleInputKeyUp"
                       placeholder="PR # (e.g. 123)" class="ns-input" />
            }
            else if (wtMode == WtMode.Existing)
            {
                var repoWts = RepoManager.Worktrees.Where(w => w.RepoId == selectedRepoId).ToList();
                @if (repoWts.Count > 0)
                {
                    <select class="ns-repo-select" value="@selectedWorktreeId" @onchange="OnExistingWtChanged">
                        @foreach (var wt in repoWts)
                        {
                            <option value="@wt.Id">‚ëÇ @wt.Branch @(wt.PrNumber.HasValue ? $"(#{wt.PrNumber})" : "")</option>
                        }
                    </select>
                }
                else
                {
                    <div class="ns-hint">No existing worktrees ‚Äî try ‚ö° Auto or ‚ëÇ Branch</div>
                }
            }

            @if (!string.IsNullOrEmpty(worktreeError))
            {
                <div class="ns-error">‚ö† @worktreeError</div>
            }
        }
        else if (mode == FormMode.Directory)
        {
            <div class="ns-dir-row">
                <input type="text" @bind="sessionDirectory" placeholder="Working directory..."
                       class="ns-input" style="flex:1" />
                <button class="ns-dir-browse" @onclick="BrowseDirectory">‚Ä¶</button>
            </div>
        }

        <input type="text" value="@SessionName" @oninput="OnNameInput" @onkeyup="HandleKeyUp"
               placeholder="Session name..." class="ns-name" />
        <textarea @bind="initialPrompt" placeholder="What should this session do? (optional)"
                  class="ns-prompt" rows="2"></textarea>

        <div class="ns-footer">
            <ModelSelector Value="@SelectedModel" ValueChanged="OnModelSelected" Models="AvailableModels" CssClass="ns-model" />
            <div class="ns-footer-actions">
                <button class="ns-cancel" @onclick="Collapse">Cancel</button>
                <button class="ns-create" @onclick="TriggerCreate"
                        disabled="@(IsCreating || isCreatingWorktree || string.IsNullOrWhiteSpace(SessionName))">
                    @if (IsCreating || isCreatingWorktree) { <span>‚Ä¶</span> } else { <span>Create</span> }
                </button>
            </div>
        </div>

        @if (!string.IsNullOrEmpty(CreateError))
        {
            <div class="ns-error">‚ö† @CreateError</div>
        }
    </div>
}

@code {
    [Parameter] public bool IsCreating { get; set; }
    [Parameter] public string? CreateError { get; set; }
    [Parameter] public List<string> AvailableModels { get; set; } = new();
    [Parameter] public string SelectedModel { get; set; } = "claude-opus-4.6";
    [Parameter] public EventCallback<string> SelectedModelChanged { get; set; }

    [Parameter] public EventCallback<(string Name, string Model, string Directory, string? WorktreeId, string? InitialPrompt, string? RepoId, string? BranchName, int? PrNumber)> OnCreate { get; set; }
    [Parameter] public EventCallback OnBrowseDirectory { get; set; }
    [Parameter] public string SessionName { get; set; } = "";
    [Parameter] public EventCallback<string> SessionNameChanged { get; set; }

    private enum FormMode { Repo, Directory, Empty }
    private enum WtMode { Auto, Branch, PR, Existing }

    private bool isExpanded;
    private FormMode mode;
    private WtMode wtMode = WtMode.Auto;
    private string? selectedRepoId;
    private string? selectedWorktreeId;
    private string branchInput = "";
    private string prInput = "";
    private string initialPrompt = "";
    private string sessionDirectory = "";
    private string? worktreeError;
    private bool isCreatingWorktree;
    private bool nameManuallyEdited;

    private void Expand()
    {
        isExpanded = true;
        nameManuallyEdited = false;
        mode = RepoManager.Repositories.Count > 0 ? FormMode.Repo : FormMode.Empty;
        if (RepoManager.Repositories.Count > 0)
            selectedRepoId = RepoManager.Repositories[0].Id;
        AutoSelectFirstWorktree();
    }

    public void ExpandForRepo(string repoId)
    {
        isExpanded = true;
        nameManuallyEdited = false;
        mode = FormMode.Repo;
        selectedRepoId = repoId;
        wtMode = WtMode.Auto;
        AutoSelectFirstWorktree();
        StateHasChanged();
    }

    private void Collapse()
    {
        isExpanded = false;
        worktreeError = null;
        branchInput = "";
        prInput = "";
        sessionDirectory = "";
        initialPrompt = "";
        selectedWorktreeId = null;
        nameManuallyEdited = false;
    }

    private void SetMode(FormMode newMode)
    {
        mode = newMode;
        worktreeError = null;
        if (!nameManuallyEdited) { SessionName = ""; _ = SessionNameChanged.InvokeAsync(""); }
    }

    private void SetWtMode(WtMode newWtMode)
    {
        wtMode = newWtMode;
        worktreeError = null;
        branchInput = "";
        prInput = "";
        if (newWtMode == WtMode.Existing)
            AutoSelectFirstWorktree();
        if (!nameManuallyEdited) UpdateAutoName();
    }

    private void OnRepoChanged(ChangeEventArgs e)
    {
        selectedRepoId = e.Value?.ToString();
        if (wtMode == WtMode.Existing) AutoSelectFirstWorktree();
        if (!nameManuallyEdited) UpdateAutoName();
    }

    private void OnExistingWtChanged(ChangeEventArgs e)
    {
        selectedWorktreeId = e.Value?.ToString();
        if (!nameManuallyEdited) UpdateAutoName();
    }

    private void AutoSelectFirstWorktree()
    {
        if (selectedRepoId == null) return;
        var first = RepoManager.Worktrees.FirstOrDefault(w => w.RepoId == selectedRepoId);
        selectedWorktreeId = first?.Id;
    }

    private void UpdateAutoName()
    {
        if (nameManuallyEdited) return;
        string? auto = null;
        if (mode == FormMode.Repo)
        {
            if (wtMode == WtMode.Branch && !string.IsNullOrWhiteSpace(branchInput))
                auto = branchInput.Trim();
            else if (wtMode == WtMode.PR && !string.IsNullOrWhiteSpace(prInput))
                auto = $"PR #{prInput.Trim().TrimStart('#')}";
            else if (wtMode == WtMode.Existing && selectedWorktreeId != null)
            {
                var wt = RepoManager.Worktrees.FirstOrDefault(w => w.Id == selectedWorktreeId);
                if (wt != null) auto = wt.Branch;
            }
        }
        if (auto != null)
        {
            SessionName = auto;
            _ = SessionNameChanged.InvokeAsync(auto);
        }
    }

    private async Task OnNameInput(ChangeEventArgs e)
    {
        SessionName = e.Value?.ToString() ?? "";
        nameManuallyEdited = !string.IsNullOrWhiteSpace(SessionName);
        await SessionNameChanged.InvokeAsync(SessionName);
    }

    private async Task OnModelSelected(string model)
    {
        SelectedModel = model;
        await SelectedModelChanged.InvokeAsync(model);
    }

    private async Task HandleInputKeyUp(KeyboardEventArgs e)
    {
        if (!nameManuallyEdited) UpdateAutoName();
        if (e.Key == "Enter") await TriggerCreate();
        else if (e.Key == "Escape") Collapse();
    }

    private async Task HandleKeyUp(KeyboardEventArgs e)
    {
        if (e.Key == "Escape") Collapse();
        else if (e.Key == "Enter") await TriggerCreate();
    }

    private async Task TriggerCreate()
    {
        if (string.IsNullOrWhiteSpace(SessionName) || IsCreating || isCreatingWorktree) return;

        var prompt = string.IsNullOrWhiteSpace(initialPrompt) ? null : initialPrompt.Trim();
        string? repoId = null;
        string? branchName = null;
        int? prNumber = null;
        string? wtId = null;
        string? dir = mode == FormMode.Empty ? null : "";

        if (mode == FormMode.Repo && selectedRepoId != null)
        {
            repoId = selectedRepoId;
            if (wtMode == WtMode.Auto)
            {
                // Auto-generate branch name from session name
                var sanitized = System.Text.RegularExpressions.Regex.Replace(SessionName.Trim(), @"[^a-zA-Z0-9_-]", "-").Trim('-');
                if (string.IsNullOrEmpty(sanitized)) sanitized = "session";
                branchName = $"{sanitized}-{Guid.NewGuid().ToString()[..4]}";
            }
            else if (wtMode == WtMode.Branch)
            {
                if (string.IsNullOrWhiteSpace(branchInput)) { worktreeError = "Enter a branch name"; return; }
                branchName = branchInput.Trim();
            }
            else if (wtMode == WtMode.PR)
            {
                if (!int.TryParse(prInput.Trim().TrimStart('#'), out var pr) || pr <= 0)
                { worktreeError = "Enter a valid PR number"; return; }
                prNumber = pr;
            }
            else if (wtMode == WtMode.Existing)
            {
                if (string.IsNullOrEmpty(selectedWorktreeId)) { worktreeError = "Select a worktree"; return; }
                wtId = selectedWorktreeId;
            }
        }
        else if (mode == FormMode.Directory)
        {
            dir = sessionDirectory;
        }

        worktreeError = null;
        await OnCreate.InvokeAsync((SessionName, SelectedModel, dir, wtId, prompt, repoId, branchName, prNumber));

        // Reset form
        branchInput = ""; prInput = ""; sessionDirectory = ""; initialPrompt = "";
        selectedWorktreeId = null; nameManuallyEdited = false;
        isExpanded = false;
    }

    private async Task BrowseDirectory()
    {
#if MACCATALYST || WINDOWS
        try
        {
            var dir = await FolderPickerService.PickFolderAsync();
            if (!string.IsNullOrEmpty(dir))
            { sessionDirectory = dir; StateHasChanged(); }
        }
        catch (Exception ex) { Console.WriteLine($"Folder picker error: {ex.Message}"); }
#else
        await OnBrowseDirectory.InvokeAsync();
#endif
    }

    public void SetDirectory(string path)
    {
        sessionDirectory = path;
        StateHasChanged();
    }
}
