@using AutoPilot.App.Models
@using Markdig

@* Shared chat message list ‚Äî used by both Home.razor (full) and Dashboard.razor (compact) *@

<div class="chat-message-list @(Compact ? "compact" : "full")">
    @if (!Messages.Any() && string.IsNullOrEmpty(StreamingContent))
    {
        <p class="chat-empty">@(Compact ? "No messages yet" : "Start a conversation with Copilot!")</p>
    }
    else
    {
        @foreach (var msg in Messages)
        {
            @switch (msg.MessageType)
            {
                case ChatMessageType.User:
                    <div class="chat-msg user">
                        @if (!Compact)
                        {
                            <div class="chat-msg-avatar">üë§</div>
                        }
                        <div class="chat-msg-content">
                            @if (Compact)
                            {
                                <span class="chat-msg-role">You</span>
                            }
                            <div class="chat-msg-text">@((MarkupString)FormatUserMessage(msg.Content))</div>
                            @if (!Compact)
                            {
                                <div class="chat-msg-time">@msg.Timestamp.ToString("HH:mm")</div>
                            }
                        </div>
                    </div>
                    break;

                case ChatMessageType.Assistant:
                    <div class="chat-msg assistant">
                        @if (!Compact)
                        {
                            <div class="chat-msg-avatar"><img src="autopilot_logo.png" width="22" height="22" alt="AutoPilot" /></div>
                        }
                        <div class="chat-msg-content">
                            @if (Compact)
                            {
                                <span class="chat-msg-role">AI</span>
                            }
                            <div class="chat-msg-text markdown-body">@((MarkupString)RenderMarkdown(msg.Content))</div>
                            @if (!Compact)
                            {
                                <div class="chat-msg-time">@msg.Timestamp.ToString("HH:mm")</div>
                            }
                        </div>
                    </div>
                    break;

                case ChatMessageType.Reasoning:
                    @if (Compact)
                    {
                        <div class="chat-msg reasoning">
                            <span class="chat-msg-role">üí°</span>
                            <span class="chat-msg-text">@(msg.IsComplete ? "Thought" : "Thinking...")</span>
                        </div>
                    }
                    else
                    {
                        <div class="reasoning-block @(msg.IsCollapsed && LineCount(msg.Content) > 5 ? "collapsed" : "")">
                            <button class="reasoning-header" @onclick="() => msg.IsCollapsed = !msg.IsCollapsed">
                                <span class="reasoning-title">üí° @(msg.IsComplete ? "Thought" : "Thinking...")</span>
                                @if (LineCount(msg.Content) > 5)
                                {
                                    <span class="collapse-icon">@(msg.IsCollapsed ? "‚ñ∂" : "‚ñº")</span>
                                }
                            </button>
                            @if (!msg.IsCollapsed || LineCount(msg.Content) <= 5)
                            {
                                <div class="reasoning-content">@msg.Content</div>
                            }
                            else
                            {
                                <div class="reasoning-content preview">@FirstLines(msg.Content, 3)</div>
                            }
                        </div>
                    }
                    break;

                case ChatMessageType.ToolCall:
                    @if (Compact)
                    {
                        <div class="chat-msg tool">
                            <span class="chat-msg-role">üîß</span>
                            <span class="chat-msg-text">@FormatToolName(msg.ToolName ?? "tool") @(msg.IsComplete ? (msg.IsSuccess ? "‚úì" : "‚úó") : "‚Ä¶")</span>
                        </div>
                    }
                    else if (msg.ToolName == "task_complete")
                    {
                        <div class="task-complete-card">
                            ‚úÖ
                            <span class="task-complete-text">@(string.IsNullOrEmpty(msg.Content) || IsUnusableResult(msg.Content) ? "Task complete" : msg.Content)</span>
                        </div>
                    }
                    else
                    {
                        <div class="tool-card @(msg.IsComplete ? (msg.IsSuccess ? "success" : "error") : "running")">
                            <div class="tool-header">
                                <span class="tool-info">üîß @FormatToolName(msg.ToolName ?? "")</span>
                                <span class="tool-status">
                                    @if (!msg.IsComplete)
                                    {
                                        <span>‚è≥ Running</span>
                                    }
                                    else if (msg.IsSuccess)
                                    {
                                        <span>‚úÖ Done</span>
                                    }
                                    else
                                    {
                                        <span>‚ùå Failed</span>
                                    }
                                </span>
                            </div>
                            @if (msg.IsComplete && !string.IsNullOrEmpty(msg.Content) && !IsUnusableResult(msg.Content))
                            {
                                @if (GetImagePath(msg.Content) is string imgPath && FileToDataUri(imgPath) is string dataUri)
                                {
                                    <div class="tool-result-section tool-image-result">
                                        <img src="@dataUri" alt="@System.IO.Path.GetFileName(imgPath)" />
                                    </div>
                                }
                                else if (LineCount(msg.Content) <= 5)
                                {
                                    <div class="tool-result-section">
                                        <pre class="tool-result-content">@TruncateResult(msg.Content)</pre>
                                    </div>
                                }
                                else
                                {
                                    <div class="tool-result-section">
                                        <button class="tool-result-toggle" @onclick="() => msg.IsCollapsed = !msg.IsCollapsed">
                                            @(msg.IsCollapsed ? "Show Full Result ‚ñ∂" : "Collapse ‚ñº")
                                        </button>
                                        @if (!msg.IsCollapsed)
                                        {
                                            <pre class="tool-result-content">@TruncateResult(msg.Content)</pre>
                                        }
                                        else
                                        {
                                            <pre class="tool-result-content preview">@FirstLines(msg.Content, 3)</pre>
                                        }
                                    </div>
                                }
                            }
                        </div>
                    }
                    break;

                case ChatMessageType.Error:
                    <div class="@(Compact ? "chat-msg error" : "error-card")">
                        @if (Compact)
                        {
                            <span class="chat-msg-role">‚ö†Ô∏è</span>
                            <span class="chat-msg-text">@msg.Content</span>
                        }
                        else
                        {
                            <span class="error-icon">‚ö†Ô∏è</span>
                            <span class="error-text">@msg.Content</span>
                        }
                    </div>
                    break;

                case ChatMessageType.System:
                    <div class="chat-msg system">
                        <div class="system-text">@msg.Content</div>
                    </div>
                    break;
            }
        }

        @* Current tool activity *@
        @if (!string.IsNullOrEmpty(CurrentToolName))
        {
            @if (Compact)
            {
                <div class="chat-msg tool">
                    <span class="chat-msg-role">üîß</span>
                    <span class="chat-msg-text">@FormatToolName(CurrentToolName) ‚Ä¶</span>
                </div>
            }
            else
            {
                <div class="tool-card running">
                    <div class="tool-header">
                        <span class="tool-info">üîß @FormatToolName(CurrentToolName)</span>
                        <span class="tool-status">‚è≥ @ToolCount tool@(ToolCount != 1 ? "s" : "")</span>
                    </div>
                </div>
            }
        }

        @* Streaming content *@
        @if (!string.IsNullOrEmpty(StreamingContent))
        {
            <div class="chat-msg assistant streaming">
                @if (!Compact)
                {
                    <div class="chat-msg-avatar"><img src="autopilot_logo.png" width="22" height="22" alt="AutoPilot" /></div>
                }
                <div class="chat-msg-content">
                    @if (Compact)
                    {
                        <span class="chat-msg-role">AI</span>
                    }
                    <div class="chat-msg-text markdown-body">@((MarkupString)RenderMarkdown(StreamingContent))</div>
                </div>
            </div>
        }

        @* Activity indicator *@
        @if (IsProcessing && string.IsNullOrEmpty(StreamingContent) && string.IsNullOrEmpty(CurrentToolName))
        {
            <div class="chat-msg assistant">
                @if (Compact)
                {
                    <span class="chat-msg-role">AI</span>
                    <span class="chat-msg-text thinking">@if (string.IsNullOrEmpty(ActivityText)) { <span class="thinking-label">Thinking<span class="dots"><span>.</span><span>.</span><span>.</span></span></span> } else { @ActivityText }</span>
                }
                else
                {
                    <div class="chat-msg-avatar"><img src="autopilot_logo.png" width="22" height="22" alt="AutoPilot" /></div>
                    <div class="chat-msg-content">
                        <div class="chat-msg-text thinking">@if (string.IsNullOrEmpty(ActivityText)) { <span class="thinking-label">Thinking<span class="dots"><span>.</span><span>.</span><span>.</span></span></span> } else { @ActivityText }</div>
                    </div>
                }
            </div>
        }
    }
</div>

@code {
    [Parameter] public List<ChatMessage> Messages { get; set; } = new();
    [Parameter] public string StreamingContent { get; set; } = "";
    [Parameter] public string CurrentToolName { get; set; } = "";
    [Parameter] public int ToolCount { get; set; }
    [Parameter] public string ActivityText { get; set; } = "";
    [Parameter] public bool IsProcessing { get; set; }
    [Parameter] public bool Compact { get; set; }

    private static readonly MarkdownPipeline MdPipeline = new MarkdownPipelineBuilder()
        .UseAdvancedExtensions().Build();

    private static readonly Dictionary<string, string> _imageCache = new();
    private static readonly Dictionary<int, string> _markdownCache = new();

    private static readonly System.Text.RegularExpressions.Regex ImagePathRegex = new(
        @"(?<!\(|""|\w)((?:/[\w\-. ]+)+\.(?:png|jpg|jpeg|gif|webp|svg|bmp|tiff))(?!\)|""|\w)",
        System.Text.RegularExpressions.RegexOptions.IgnoreCase | System.Text.RegularExpressions.RegexOptions.Compiled);

    internal static string RenderMarkdown(string content)
    {
        if (string.IsNullOrEmpty(content)) return "";
        var key = content.GetHashCode();
        if (_markdownCache.TryGetValue(key, out var cached)) return cached;
        try
        {
            var html = Markdig.Markdown.ToHtml(content, MdPipeline);
            html = ImagePathRegex.Replace(html, match =>
            {
                var path = match.Value;
                var dataUri = FileToDataUri(path);
                if (dataUri != null)
                    return $"<img src=\"{dataUri}\" alt=\"{System.IO.Path.GetFileName(path)}\" />";
                return match.Value;
            });
            if (_markdownCache.Count < 500) _markdownCache[key] = html;
            return html;
        }
        catch { return System.Net.WebUtility.HtmlEncode(content).Replace("\n", "<br/>"); }
    }

    internal static string FormatUserMessage(string content)
    {
        if (string.IsNullOrEmpty(content)) return "";
        var lines = content.Split('\n');
        var sb = new System.Text.StringBuilder();
        foreach (var line in lines)
        {
            var trimmed = line.Trim();
            if (trimmed.StartsWith('/') && ImageExtensions.Any(ext => 
                trimmed.EndsWith(ext, StringComparison.OrdinalIgnoreCase)) &&
                System.IO.File.Exists(trimmed))
            {
                var dataUri = FileToDataUri(trimmed);
                if (dataUri != null)
                {
                    sb.Append($"<div class=\"user-image-attachment\"><img src=\"{dataUri}\" alt=\"{System.Net.WebUtility.HtmlEncode(System.IO.Path.GetFileName(trimmed))}\" /><span class=\"user-image-name\">{System.Net.WebUtility.HtmlEncode(System.IO.Path.GetFileName(trimmed))}</span></div>");
                    continue;
                }
            }
            if (sb.Length > 0) sb.Append("<br/>");
            sb.Append(System.Net.WebUtility.HtmlEncode(line));
        }
        return sb.ToString();
    }

    internal static int LineCount(string? text)
    {
        if (string.IsNullOrEmpty(text)) return 0;
        var count = 1;
        foreach (var c in text) { if (c == '\n') count++; }
        return count;
    }

    internal static string FirstLines(string? text, int lines)
    {
        if (string.IsNullOrEmpty(text)) return "";
        var idx = 0;
        for (var i = 0; i < lines && idx < text.Length; i++)
        {
            var next = text.IndexOf('\n', idx);
            if (next < 0) break;
            idx = next + 1;
        }
        if (idx <= 0 || idx >= text.Length) return text;
        return text[..idx] + "‚Ä¶";
    }

    internal static string FormatToolName(string toolName)
    {
        if (string.IsNullOrEmpty(toolName)) return "";
        return string.Join(" ", toolName.Split('_').Select(w =>
            w.Length > 0 ? char.ToUpperInvariant(w[0]) + w[1..].ToLowerInvariant() : w));
    }

    internal static string TruncateResult(string result, int maxLength = 1500)
    {
        if (string.IsNullOrEmpty(result) || result.Length <= maxLength) return result ?? "";
        return result[..maxLength] + "\n‚Ä¶ (truncated)";
    }

    internal static bool IsUnusableResult(string? content)
    {
        if (string.IsNullOrEmpty(content)) return true;
        if (content.StartsWith("GitHub.Copilot.SDK.")) return true;
        if (content is "(no result)" or "Intent logged") return true;
        return false;
    }

    private static readonly string[] ImageExtensions = { ".png", ".jpg", ".jpeg", ".gif", ".webp", ".svg", ".bmp", ".tiff" };

    internal static string? GetImagePath(string? content)
    {
        if (string.IsNullOrWhiteSpace(content)) return null;
        var trimmed = content.Trim();
        foreach (var ext in ImageExtensions)
        {
            var idx = trimmed.LastIndexOf(ext, StringComparison.OrdinalIgnoreCase);
            if (idx < 0) continue;
            var endIdx = idx + ext.Length;
            var pathStart = trimmed.LastIndexOf(' ', idx) + 1;
            if (pathStart < 0) pathStart = 0;
            var path = trimmed[pathStart..endIdx];
            if (path.StartsWith('/') && System.IO.File.Exists(path))
                return path;
        }
        return null;
    }

    internal static string? FileToDataUri(string path)
    {
        if (_imageCache.TryGetValue(path, out var cached)) return cached;
        try
        {
            if (!System.IO.File.Exists(path)) return null;
            var bytes = System.IO.File.ReadAllBytes(path);
            var ext = System.IO.Path.GetExtension(path).ToLowerInvariant();
            var mime = ext switch
            {
                ".png" => "image/png",
                ".jpg" or ".jpeg" => "image/jpeg",
                ".gif" => "image/gif",
                ".webp" => "image/webp",
                ".svg" => "image/svg+xml",
                ".bmp" => "image/bmp",
                ".tiff" or ".tif" => "image/tiff",
                _ => "application/octet-stream"
            };
            var dataUri = $"data:{mime};base64,{Convert.ToBase64String(bytes)}";
            _imageCache[path] = dataUri;
            return dataUri;
        }
        catch { return null; }
    }
}
